<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Who's The Dumbass?</title>
  <style>
    :root {
      --neon-green: #4ecdc4;
      --neon-purple: #A855F7;
      --text-secondary: #888;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }
    
    .bg-grid {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: linear-gradient(rgba(0, 255, 136, 0.08) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(0, 255, 136, 0.08) 1px, transparent 1px);
      background-size: 50px 50px;
      pointer-events: none;
      z-index: 0;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }
    
    h1 {
      text-align: center;
      font-size: 2.5rem;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .subtitle {
      text-align: center;
      color: #888;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    .step {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .step.active {
      border-color: var(--neon-green);
      box-shadow: 0 0 20px rgba(78, 205, 196, 0.2);
    }
    
    .step.completed {
      border-color: rgba(78, 205, 196, 0.3);
      opacity: 0.7;
    }
    
    .step-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .step-number {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
    }
    
    .step.active .step-number {
      background: var(--neon-green);
      color: #000;
    }
    
    .step-title {
      font-weight: 600;
      font-size: 1.1rem;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #ddd;
    }
    
    input[type="text"] {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #333;
      border-radius: 8px;
      background: #1a1a2e;
      color: #fff;
      font-size: 16px;
      margin-bottom: 15px;
    }
    
    input[type="text"]:focus {
      outline: none;
      border-color: var(--neon-green);
    }
    
    textarea {
      width: 100%;
      height: 120px;
      padding: 15px;
      border: 2px solid #333;
      border-radius: 10px;
      background: #1a1a2e;
      color: #fff;
      font-size: 14px;
      resize: vertical;
      line-height: 1.5;
    }
    
    textarea:focus {
      outline: none;
      border-color: var(--neon-green);
    }
    
    textarea::placeholder {
      color: #555;
    }
    
    .btn-primary {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-copy {
      width: 100%;
      padding: 14px;
      background: var(--neon-green);
      color: #000;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-copy:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(78, 205, 196, 0.4);
    }
    
    .prompt-box {
      background: #0f0c29;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 11px;
      color: var(--neon-green);
      max-height: 200px;
      overflow-y: auto;
      word-break: break-word;
      white-space: pre-wrap;
    }
    
    #status {
      text-align: center;
      margin: 20px 0;
      font-size: 16px;
      min-height: 24px;
      color: #aaa;
    }
    
    #status.error {
      color: #f5576c;
    }
    
    #status.success {
      color: var(--neon-green);
    }
    
    .result-box {
      display: none;
      margin-top: 25px;
      padding: 20px;
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .result-box.show {
      display: block;
    }
    
    .iq-display {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .iq-number {
      font-size: 64px;
      font-weight: bold;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .iq-label {
      font-size: 14px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    
    .verdict {
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      margin: 15px 0;
      padding: 15px;
      border-radius: 10px;
      background: rgba(0,0,0,0.3);
    }
    
    .roast {
      text-align: center;
      font-size: 14px;
      color: #aaa;
      font-style: italic;
      margin: 10px 0;
      padding: 10px;
    }
    
    .leaderboard-section {
      margin-top: 40px;
      padding-top: 30px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .leaderboard-section h2 {
      text-align: center;
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: #ffd700;
    }
    
    .leaderboard-container {
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #1a1a2e;
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .toast.show {
      opacity: 1;
    }
    
    .footer {
      text-align: center;
      margin-top: 40px;
      padding: 20px;
      color: #555;
      font-size: 12px;
      line-height: 1.8;
    }
    
    .secure-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 10px;
      padding: 8px 16px;
      background: rgba(78, 205, 196, 0.1);
      border: 1px solid rgba(78, 205, 196, 0.3);
      border-radius: 20px;
      font-size: 11px;
      color: var(--neon-green);
    }
  </style>
</head>
<body>
  <div class="bg-grid"></div>
  
  <div class="container">
    <h1>üß† Who's The Dumbass?</h1>
    <p style="font-size: 1.15rem; color: rgba(255,255,255,0.6); max-width: 600px; margin: 0 auto 30px; line-height: 1.7; text-align: center;">
      Let your AI judge how smart you actually are. We rank the results. It's free ‚Äî perfect for dumbasses like you.
    </p>
    
    <!-- Step 1: Enter Name + Get Prompt -->
    <div id="step1" class="step active">
      <div class="step-header">
        <div class="step-number">1</div>
        <div class="step-title">Enter Your Name & Get Prompt</div>
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="color: rgba(255,255,255,0.6); font-size: 0.85rem; display: block; margin-bottom: 6px;">
          Username <span style="color: #EF4444;">*</span>
        </label>
        <input type="text" id="usernameInput" placeholder="Pick a name for the leaderboard" required maxlength="20"
          style="width: 100%; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; color: #fff; font-size: 1rem; outline: none; box-sizing: border-box; transition: border-color 0.3s;"
          onfocus="this.style.borderColor='var(--neon-green)'"
          onblur="this.style.borderColor='rgba(255,255,255,0.15)'"
          oninput="handleResponseInput()"
        />
      </div>
      
      <div id="urlFieldSection" style="margin-bottom: 16px;">
        <label style="color: rgba(255,255,255,0.6); font-size: 0.85rem; display: block; margin-bottom: 6px;">
          Your URL <span style="color: rgba(255,255,255,0.3);">(shown on leaderboard if you qualify)</span>
        </label>
        <input type="url" id="userUrlInput" placeholder="https://your-website.com"
          style="width: 100%; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; color: #fff; font-size: 1rem; outline: none; box-sizing: border-box; transition: border-color 0.3s;"
          onfocus="this.style.borderColor='var(--neon-green)'"
          onblur="this.style.borderColor='rgba(255,255,255,0.15)'"
        />
        <label style="display: flex; align-items: center; gap: 8px; margin-top: 8px; cursor: pointer; color: rgba(255,255,255,0.4); font-size: 0.85rem;">
          <input type="checkbox" id="skipUrlCheckbox" onchange="document.getElementById('userUrlInput').disabled = this.checked; document.getElementById('userUrlInput').style.opacity = this.checked ? '0.3' : '1';" style="accent-color: var(--neon-green);" />
          Skip ‚Äî I don't want a URL on the leaderboard
        </label>
      </div>
      
      <button id="getPromptBtn" class="btn-copy" onclick="getPrompt()">üìã Copy Prompt</button>
      
      <div id="promptBox" class="prompt-box" style="display: none;"></div>
    </div>
    
    <!-- Step 2: Instructions -->
    <div id="step2" class="step">
      <div class="step-header">
        <div class="step-number">2</div>
        <div class="step-title">Paste into Your AI</div>
      </div>
      
      <ol style="color: var(--text-secondary); font-size: 0.95rem; padding-left: 24px; line-height: 1.8;">
        <li>Open any AI you use (ChatGPT, Grok, Gemini, Claude)</li>
        <li>Paste the prompt into the chat</li>
        <li>Copy the <strong style="color: var(--neon-purple);">WTD::...</strong> line it gives back</li>
        <li>Paste it below and hit Verify</li>
      </ol>
    </div>
    
    <!-- Step 3: Paste Response -->
    <div id="step3" class="step">
      <div class="step-header">
        <div class="step-number">3</div>
        <div class="step-title">Paste AI Response & Verify</div>
      </div>
      
      <label for="responseInput">AI Response</label>
      <textarea id="responseInput" placeholder="Paste the AI response here (the WTD::... line)" oninput="handleResponseInput()"></textarea>
      
      <button id="submitBtn" class="btn-primary" disabled onclick="submitTest()">üéØ Verify & Get Score</button>
    </div>
    
    <p id="status"></p>
    
    <!-- Results -->
    <div id="resultBox" class="result-box">
      <div class="iq-display">
        <div class="iq-number" id="iqNumber">--</div>
        <div class="iq-label">Estimated IQ</div>
      </div>
      
      <div id="verdict" class="verdict"></div>
      <div id="roast" class="roast"></div>
    </div>
    
    <!-- Leaderboard Section -->
    <div class="leaderboard-section">
      <h2>üèÜ Leaderboard</h2>
      
      <!-- Search bar -->
      <div style="margin-bottom: 16px; display: flex; gap: 8px;">
        <input type="text" id="leaderboardSearch" placeholder="Search by name..." 
          style="flex: 1; padding: 10px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; color: #fff; font-size: 0.95rem; outline: none; transition: border-color 0.3s;"
          onfocus="this.style.borderColor='var(--neon-green)'"
          onblur="this.style.borderColor='rgba(255,255,255,0.15)'"
        />
        <button onclick="searchLeaderboard()" style="padding: 10px 20px; background: var(--neon-green); color: #000; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95rem; white-space: nowrap;">
          Search
        </button>
      </div>
      
      <!-- Spotlights -->
      <div id="topGenius"></div>
      <div id="biggestDumbass"></div>
      
      <div id="leaderboardEntries" class="leaderboard-container">
        <p style="color: #666; text-align: center;">Loading leaderboard...</p>
      </div>
    </div>
    
    <div class="footer">
      <p>Results are cryptographically signed and tamper-proof.</p>
      <div class="secure-badge">
        üîí Your AI rates you securely. The scoring algorithm is hidden.
      </div>
    </div>
  </div>
  
  <script>
    const API_BASE = "https://whosthedumbass-api.warwideweb.workers.dev";
    
    let currentNonce = null;
    let currentPrompt = null;
    
    // Toast notification
    function showToast(message) {
      let toast = document.querySelector('.toast');
      if (!toast) {
        toast = document.createElement('div');
        toast.className = 'toast';
        document.body.appendChild(toast);
      }
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
    
    // Escape HTML
    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
    
    // Step 1: Get Prompt
    async function getPrompt() {
      const btn = document.getElementById('getPromptBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Loading...';
      
      try {
        const res = await fetch(`${API_BASE}/prompt`);
        const data = await res.json();
        
        if (!data.ok) {
          throw new Error(data.error || 'Failed to get prompt');
        }
        
        currentNonce = data.nonce;
        currentPrompt = data.prompt;
        
        // Show prompt
        const promptBox = document.getElementById('promptBox');
        promptBox.textContent = data.prompt;
        promptBox.style.display = 'block';
        
        // Copy to clipboard
        await navigator.clipboard.writeText(data.prompt);
        
        btn.textContent = '‚úÖ Copied!';
        showToast('‚úÖ Copied! Paste into any AI and copy back the WTD:: response.');
        
        // Activate step 2
        document.getElementById('step1').classList.add('completed');
        document.getElementById('step1').classList.remove('active');
        document.getElementById('step2').classList.add('active');
        
        setTimeout(() => {
          btn.textContent = 'üìã Copy Again';
          btn.disabled = false;
        }, 2000);
        
      } catch (e) {
        showToast('‚ùå ' + e.message);
        btn.textContent = 'üìã Copy Prompt';
        btn.disabled = false;
      }
    }
    
    // Handle response input
    function handleResponseInput() {
      const response = (document.getElementById('responseInput').value || '').trim();
      const username = (document.getElementById('usernameInput').value || '').trim();
      
      const hasToken = response.includes('WTD::') || 
                       response.includes('IQ2ENC::') || 
                       response.includes('IQ2RAW2::') || 
                       response.includes('IQ2RES2::');
      
      // Username required (2+ chars) + valid token + nonce
      document.getElementById('submitBtn').disabled = !(hasToken && username.length >= 2 && currentNonce);
      
      if (hasToken) {
        const step2 = document.getElementById('step2');
        if (step2) {
          step2.classList.add('completed');
          step2.classList.remove('active');
        }
        const step3 = document.getElementById('step3');
        if (step3) step3.classList.add('active');
      }
    }
    
    // Dumbass popup for IQ < 120
    function showDumbassPopup(iq, userId) {
      const existing = document.getElementById('dumbassPopup');
      if (existing) existing.remove();
      
      const popup = document.createElement('div');
      popup.id = 'dumbassPopup';
      popup.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="if(event.target===this)this.parentElement.remove()">
          <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid rgba(239,68,68,0.5); border-radius: 16px; padding: 32px; max-width: 440px; width: 100%; text-align: center; box-shadow: 0 0 40px rgba(239,68,68,0.2);">
            <div style="font-size: 3rem; margin-bottom: 12px;">üíÄ</div>
            <div style="font-size: 1.5rem; font-weight: 800; color: #EF4444; margin-bottom: 8px;">
              ${iq} IQ? Really?
            </div>
            <div style="color: rgba(255,255,255,0.7); font-size: 1rem; line-height: 1.6; margin-bottom: 24px;">
              Since you're clearly a dumbass, why not double down? Boost your rank, get a free URL link on the leaderboard, and flex on the other idiots below you.
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <button onclick="document.getElementById('dumbassPopup').remove(); document.querySelector('[data-boost-section]')?.scrollIntoView({behavior:'smooth'});" style="padding: 14px 24px; background: linear-gradient(135deg, #EF4444, #DC2626); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 1.05rem; box-shadow: 0 0 20px rgba(239,68,68,0.3); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                üí∏ Boost My Rank (I Accept I'm Dumb)
              </button>
              <button onclick="document.getElementById('dumbassPopup').remove()" style="padding: 10px 24px; background: transparent; color: rgba(255,255,255,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; cursor: pointer; font-size: 0.9rem;">
                No thanks, I'll stay at the bottom
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(popup);
    }
    
    // Submit test
    async function submitTest() {
      const response = (document.getElementById('responseInput').value || '').trim();
      const username = (document.getElementById('usernameInput').value || 'Anonymous').trim();
      
      const hasToken = response.includes('WTD::') || 
                       response.includes('IQ2ENC::') || 
                       response.includes('IQ2RAW2::') || 
                       response.includes('IQ2RES2::');
      
      if (!hasToken) {
        showToast('‚ùå Paste the AI response (the WTD::... line)');
        return;
      }
      
      const statusEl = document.getElementById('status');
      const submitBtn = document.getElementById('submitBtn');
      
      submitBtn.disabled = true;
      submitBtn.textContent = '‚è≥ Verifying...';
      statusEl.textContent = 'üîç Checking your scores...';
      statusEl.className = '';
      
      try {
        const res = await fetch(`${API_BASE}/verify`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ response, username })
        });
        
        const data = await res.json();
        
        if (!data.ok) {
          const errorMap = {
            'missing_response': '‚ùå Please paste the AI response first.',
            'no_token': '‚ùå Could not find WTD:: in the response. Copy the AI\'s full output.',
            'invalid_nonce': '‚ùå Session expired. Click Copy Prompt for a new one.',
            'nonce_used': '‚ùå Already submitted. Click Copy Prompt for a new one.',
            'nonce_expired': '‚ùå Session expired (10 min limit). Click Copy Prompt for a new one.',
            'invalid_scores': '‚ùå Invalid data. Copy the complete AI response.',
            'invalid_score_range': '‚ùå Scores out of range. Don\'t edit the AI output.',
            'checksum_failed': '‚ùå Integrity check failed. Copy the response exactly as-is.',
            'suspicious_scores': '‚ùå Scores look manipulated. Try again honestly.',
            'legacy_format': '‚ùå Old format. Click Copy Prompt for a new one.',
          };
          throw new Error(errorMap[data.error] || data.detail || data.error);
        }
        
        // Success!
        statusEl.textContent = '‚úÖ Verified!';
        statusEl.className = 'success';
        
        // Display results
        document.getElementById('iqNumber').textContent = data.iq_score;
        
        // Verdict
        const verdict = document.getElementById('verdict');
        const tier = data.tier || {};
        verdict.textContent = `${tier.emoji || ''} ${tier.name || 'Unknown'}`;
        verdict.style.color = tier.color || '#fff';
        
        // Roast
        document.getElementById('roast').textContent = data.roast || '';
        
        document.getElementById('resultBox').classList.add('show');
        
        // Auto-save URL if entered
        const userUrl = document.getElementById('userUrlInput')?.value?.trim();
        const skipUrl = document.getElementById('skipUrlCheckbox')?.checked;
        if (userUrl && !skipUrl && data.userId) {
          fetch(`${API_BASE}/save-link`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: data.userId, dna2: data.dna2, url: userUrl }),
          }).catch(() => {}); // Silent - don't block results
        }
        
        // Show dumbass popup for IQ < 120
        if (data.iq_score < 120) {
          setTimeout(() => showDumbassPopup(data.iq_score, data.userId), 2000);
        }
        
        // Reload leaderboard
        loadLeaderboard();
        
        submitBtn.textContent = '‚úÖ Done!';
        
      } catch (e) {
        statusEl.textContent = e.message;
        statusEl.className = 'error';
        submitBtn.disabled = false;
        submitBtn.textContent = 'üéØ Verify & Get Score';
      }
    }
    
    // Leaderboard functions
    function renderLeaderboardData(data) {
      // Render Top Genius spotlight
      const geniusEl = document.getElementById('topGenius');
      if (geniusEl && data.top_genius) {
        geniusEl.innerHTML = `
          <div style="background: linear-gradient(135deg, rgba(168,85,247,0.2), rgba(0,255,136,0.1)); border: 1px solid rgba(168,85,247,0.4); border-radius: 12px; padding: 16px 24px; margin-bottom: 12px; text-align: center;">
            <div style="font-size: 1.3rem; margin-bottom: 4px;">üß¨ #1 GENIUS üß¨</div>
            <div style="font-size: 1.6rem; font-weight: 800; color: #A855F7; text-shadow: 0 0 20px rgba(168,85,247,0.5);">
              ${escapeHtml(data.top_genius.username)}
            </div>
            <div style="font-size: 0.95rem; color: var(--text-secondary); margin-top: 4px;">
              IQ: ${data.top_genius.iq}
            </div>
          </div>`;
      } else if (geniusEl) geniusEl.innerHTML = '';
      
      // Render Biggest Dumbass spotlight
      const dumbassEl = document.getElementById('biggestDumbass');
      if (dumbassEl && data.biggest_dumbass) {
        dumbassEl.innerHTML = `
          <div style="background: linear-gradient(135deg, rgba(127,29,29,0.3), rgba(239,68,68,0.1)); border: 1px solid rgba(239,68,68,0.4); border-radius: 12px; padding: 16px 24px; margin-bottom: 20px; text-align: center;">
            <div style="font-size: 1.3rem; margin-bottom: 4px;">üíÄ BIGGEST DUMBASS üíÄ</div>
            <div style="font-size: 1.6rem; font-weight: 800; color: #EF4444; text-shadow: 0 0 20px rgba(239,68,68,0.5);">
              ${escapeHtml(data.biggest_dumbass.username)}
            </div>
            <div style="font-size: 0.95rem; color: var(--text-secondary); margin-top: 4px;">
              IQ: ${data.biggest_dumbass.iq}
            </div>
          </div>`;
      } else if (dumbassEl) dumbassEl.innerHTML = '';
      
      // Render leaderboard entries
      const container = document.getElementById('leaderboardEntries');
      if (container && data.leaderboard) {
        if (data.leaderboard.length === 0) {
          container.innerHTML = '<div style="text-align:center; color: var(--text-secondary); padding: 20px;">No entries yet. Be the first!</div>';
        } else {
          container.innerHTML = data.leaderboard.map((entry, i) => {
            const rank = i + 1;
            const medal = rank === 1 ? 'üëë' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;
            const badge = entry.paymentBadge ? ` ${entry.paymentBadge}` : '';
            const link = entry.link ? `<a href="${escapeHtml(entry.link)}" target="_blank" style="color: var(--neon-green); text-decoration: none; margin-left: 8px;">üîó</a>` : '';
            const glow = (entry.boost && rank <= 3) ? 'text-shadow: 0 0 10px rgba(255,215,0,0.5);' : '';
            return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.06); ${glow}">
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 1.1rem; min-width: 36px;">${medal}</span>
                <span style="font-weight: 600;">${escapeHtml(entry.username)}${badge}${link}</span>
              </div>
              <span style="font-weight: 700; color: var(--neon-green);">${entry.iq}</span>
            </div>`;
          }).join('');
        }
      }
    }
    
    async function loadLeaderboard() {
      try {
        const res = await fetch(`${API_BASE}/leaderboard`);
        const data = await res.json();
        if (data.ok) {
          renderLeaderboardData(data);
        }
      } catch (e) {
        console.error('Failed to load leaderboard:', e);
        document.getElementById('leaderboardEntries').innerHTML = 
          '<p style="color: #666; text-align: center;">Failed to load leaderboard</p>';
      }
    }
    
    async function searchLeaderboard() {
      const query = (document.getElementById('leaderboardSearch').value || '').trim();
      const url = query
        ? `${API_BASE}/leaderboard?search=${encodeURIComponent(query)}`
        : `${API_BASE}/leaderboard`;
      
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.ok) {
          renderLeaderboardData(data);
          if (query && data.leaderboard.length === 0) {
            showToast(`No results for "${query}"`);
          }
        }
      } catch (err) {
        showToast('‚ùå Failed to search leaderboard');
      }
    }
    
    // Enter key support for search
    document.addEventListener('DOMContentLoaded', () => {
      const lbSearch = document.getElementById('leaderboardSearch');
      if (lbSearch) {
        lbSearch.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') searchLeaderboard();
        });
      }
      
      // Load leaderboard on page load
      loadLeaderboard();
    });
  </script>
</body>
</html>
